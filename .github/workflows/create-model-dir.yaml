name: Create Model Output Directory

on:
  workflow_dispatch: 
  push:
    paths:
      - 'model-metadata/*.yaml'

jobs:
  create-directory:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # List YAML files in the model-metadata directory
    - name: Get YAML files
      id: yaml_files
      run: |
        # Check if this is the first commit or a normal push
        if [ $(git rev-parse --is-shallow-repository) = "true" ]; then
          git fetch --prune --unshallow
        fi
        # Handle case for first commit or initial push
        if [ $(git rev-list --count HEAD) -eq 1 ]; then
          files=$(git ls-files 'model-metadata/*.yaml')
        else
          files=$(git diff --name-only HEAD^ HEAD -- 'model-metadata/*.yaml')
        fi
        echo "yaml_files=$files" >> $GITHUB_ENV

    # Create corresponding directories in model-output
    - name: Create directories
      run: |
        for file in ${{ env.yaml_files }}; do
          file_name=$(basename "$file" .yaml)
          output_dir="./model-output/$file_name"
          if [ ! -d "$output_dir" ]; then
            mkdir -p "$output_dir"
            echo "Created directory: $output_dir"
          else
            echo "Directory $output_dir already exists"
          fi
        done

    # Commit and push changes if new directories were created
    - name: Commit changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add ./model-output
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Create model-output directories for new YAML files"
          git push
        fi
